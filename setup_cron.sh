#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É –ø–∞—Ä—Å–µ—Ä–∞

echo "üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É –ø–∞—Ä—Å–µ—Ä–∞ —à–≤–µ–π—Ü–∞—Ä—Å—å–∫–∏—Ö –Ω–æ–≤–∏–Ω"
echo "================================================================"

# –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –ø—Ä–æ–µ–∫—Ç—É: $SCRIPT_DIR"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å Python3 –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º."
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å pip
if ! command -v pip3 &> /dev/null; then
    echo "‚ùå pip3 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å pip3 –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è–º."
    exit 1
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
pip3 install -r "$SCRIPT_DIR/requirements.txt"

if [ $? -ne 0 ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ API –∫–ª—é—á
if [ -z "$OPENAI_API_KEY" ]; then
    echo "‚ö†Ô∏è  –£–í–ê–ì–ê: –ó–º—ñ–Ω–Ω–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ OPENAI_API_KEY –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    echo "–î–ª—è –ø–æ–≤–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —ó—ó:"
    echo "export OPENAI_API_KEY='your-api-key-here'"
    echo "–ê–±–æ –¥–æ–¥–∞–π—Ç–µ –≤ ~/.bashrc –∞–±–æ ~/.zshrc"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ API –∫–ª—é—á–∞? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# –°—Ç–≤–æ—Ä—é—î–º–æ —Å–∫—Ä–∏–ø—Ç-–æ–±–≥–æ—Ä—Ç–∫—É –¥–ª—è cron
WRAPPER_SCRIPT="$SCRIPT_DIR/run_parser.sh"
cat > "$WRAPPER_SCRIPT" << EOF
#!/bin/bash

# –°–∫—Ä–∏–ø—Ç-–æ–±–≥–æ—Ä—Ç–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫—É –ø–∞—Ä—Å–µ—Ä–∞ –∑ cron

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–±–æ—á—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
cd "$SCRIPT_DIR"

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
# export OPENAI_API_KEY="your-api-key-here"

# –õ–æ–≥—É–≤–∞–Ω–Ω—è
LOG_FILE="$SCRIPT_DIR/cron.log"
echo "\$(date): –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ —à–≤–µ–π—Ü–∞—Ä—Å—å–∫–∏—Ö –Ω–æ–≤–∏–Ω" >> "\$LOG_FILE"

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–∞—Ä—Å–µ—Ä
python3 "$SCRIPT_DIR/main.py" >> "\$LOG_FILE" 2>&1

# –õ–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
echo "\$(date): –ü–∞—Ä—Å–µ—Ä –∑–∞–≤–µ—Ä—à–∏–≤ —Ä–æ–±–æ—Ç—É" >> "\$LOG_FILE"
echo "----------------------------------------" >> "\$LOG_FILE"
EOF

# –†–æ–±–∏–º–æ —Å–∫—Ä–∏–ø—Ç –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º
chmod +x "$WRAPPER_SCRIPT"

echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Å–∫—Ä–∏–ø—Ç-–æ–±–≥–æ—Ä—Ç–∫—É: $WRAPPER_SCRIPT"

# –ü—Ä–æ–ø–æ–Ω—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ cron
echo ""
echo "üïí –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è cron job..."
echo "–í–∏–±–µ—Ä—ñ—Ç—å —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—É—Å–∫—É:"
echo "1) –©–æ–¥–Ω—è –æ 9:00 —Ä–∞–Ω–∫—É"
echo "2) –î–≤—ñ—á—ñ –Ω–∞ –¥–µ–Ω—å (9:00 —Ç–∞ 21:00)"
echo "3) –ö–æ–∂–Ω—ñ 6 –≥–æ–¥–∏–Ω"
echo "4) –í–ª–∞—Å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥"
echo "5) –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è cron"

read -p "–í–∞—à –≤–∏–±—ñ—Ä (1-5): " choice

case $choice in
    1)
        CRON_SCHEDULE="0 9 * * *"
        CRON_DESCRIPTION="—â–æ–¥–Ω—è –æ 9:00"
        ;;
    2)
        CRON_SCHEDULE="0 9,21 * * *"
        CRON_DESCRIPTION="–¥–≤—ñ—á—ñ –Ω–∞ –¥–µ–Ω—å –æ 9:00 —Ç–∞ 21:00"
        ;;
    3)
        CRON_SCHEDULE="0 */6 * * *"
        CRON_DESCRIPTION="–∫–æ–∂–Ω—ñ 6 –≥–æ–¥–∏–Ω"
        ;;
    4)
        echo "–í–≤–µ–¥—ñ—Ç—å cron —Ä–æ–∑–∫–ª–∞–¥ (—Ñ–æ—Ä–º–∞—Ç: —Ö–≤–∏–ª–∏–Ω–∞ –≥–æ–¥–∏–Ω–∞ –¥–µ–Ω—å –º—ñ—Å—è—Ü—å –¥–µ–Ω—å_—Ç–∏–∂–Ω—è):"
        read -p "–ü—Ä–∏–∫–ª–∞–¥: 0 9 * * * (—â–æ–¥–Ω—è –æ 9:00): " CRON_SCHEDULE
        CRON_DESCRIPTION="–∑–∞ –≤–∞—à–∏–º —Ä–æ–∑–∫–ª–∞–¥–æ–º"
        ;;
    5)
        echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è cron"
        echo "–í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–∞—Ä—Å–µ—Ä –≤—Ä—É—á–Ω—É: $WRAPPER_SCRIPT"
        exit 0
        ;;
    *)
        echo "‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –≤–∏–±—ñ—Ä"
        exit 1
        ;;
esac

# –î–æ–¥–∞—î–º–æ cron job
CRON_JOB="$CRON_SCHEDULE $WRAPPER_SCRIPT"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ —ñ—Å–Ω—É—î —Ç–∞–∫–∏–π job
if crontab -l 2>/dev/null | grep -q "$WRAPPER_SCRIPT"; then
    echo "‚ö†Ô∏è  Cron job –¥–ª—è —Ü—å–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –≤–∂–µ —ñ—Å–Ω—É—î"
    read -p "–ó–∞–º—ñ–Ω–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π job
        crontab -l 2>/dev/null | grep -v "$WRAPPER_SCRIPT" | crontab -
    else
        echo "üö´ –ó–∞–ª–∏—à–∞—î–º–æ —ñ—Å–Ω—É—é—á–∏–π cron job"
        exit 0
    fi
fi

# –î–æ–¥–∞—î–º–æ –Ω–æ–≤–∏–π job
(crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -

if [ $? -eq 0 ]; then
    echo "‚úÖ Cron job —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!"
    echo "üìÖ –†–æ–∑–∫–ª–∞–¥: $CRON_DESCRIPTION"
    echo "üîß –ö–æ–º–∞–Ω–¥–∞: $CRON_JOB"
    echo ""
    echo "üìã –ü–æ—Ç–æ—á–Ω—ñ cron jobs:"
    crontab -l | grep "$WRAPPER_SCRIPT"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ cron job"
    exit 1
fi

echo ""
echo "üéâ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìù –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
echo "   –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ cron jobs: crontab -l"
echo "   –í–∏–¥–∞–ª–∏—Ç–∏ cron job: crontab -e"
echo "   –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ª–æ–≥–∏: tail -f $SCRIPT_DIR/cron.log"
echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Ä—É—á–Ω—É: $WRAPPER_SCRIPT"
echo ""
echo "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤: $SCRIPT_DIR"
